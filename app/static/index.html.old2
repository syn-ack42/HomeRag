<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Local RAG Chat</title>

<!-- Markdown renderer -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
body { 
    font-family: system-ui, sans-serif; 
    margin: 2em; 
}
#chat { 
    border: 1px solid #ccc; 
    border-radius: 10px; 
    padding: 1em;
    height: 500px; 
    overflow-y: scroll; 
}
.user { 
    color: blue; 
    margin: .5em 0; 
}
.bot { 
    color: #003300; 
    margin: .5em 0; 
}
#q { 
    width: 80%; 
    padding: .5em; 
    font-size: 1em; 
}
</style>
</head>

<body>
<h2>Local RAG Chat</h2>

<div id="chat"></div>

<input id="q" placeholder="Ask something..." />

<hr/>

<form id="uploadForm">
    <input type="file" name="file" />
    <button type="submit">Upload & Rebuild</button>
</form>


<h3>System Prompt</h3>
<textarea id="systemPrompt" style="width:100%;height:150px;"></textarea>
<button onclick="savePrompt()">Save</button>
<button onclick="loadPrompt()">Reload</button>

<script>
async function loadPrompt() {
    const r = await fetch("/prompt");
    const data = await r.json();
    document.getElementById("systemPrompt").value = data.prompt;
}

async function savePrompt() {
    const text = document.getElementById("systemPrompt").value;
    await fetch("/prompt", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ prompt: text })
    });
    alert("Prompt saved.");
}

loadPrompt();
</script>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("q");

// simple conversation memory
let history = [];

// ENTER = send
input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
    }
});

function appendUser(msg) {
    chat.innerHTML += `<div class="user"><b>You:</b> ${msg}</div>`;
    chat.scrollTop = chat.scrollHeight;
}

function appendTyping() {
    const el = document.createElement("div");
    el.className = "bot";
    el.innerHTML = "<i>Bot is typingâ€¦</i>";
    chat.appendChild(el);
    chat.scrollTop = chat.scrollHeight;
    return el;
}

function appendBotContainer() {
    const el = document.createElement("div");
    el.className = "bot";
    el.innerHTML = "<b>Bot:</b><br>";
    chat.appendChild(el);
    chat.scrollTop = chat.scrollHeight;
    return el;
}

async function sendMessage() {
    const q = input.value.trim();
    if (!q) return;

    // add to memory
    history.push({ role: "user", content: q });

    appendUser(q);
    input.value = "";

    const typingEl = appendTyping();

    // call streaming endpoint
    const response = await fetch("/ask_stream", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ q })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buf = "";

    // create bot message container
    const botContainer = appendBotContainer();

    // prepare streaming state
    botContainer.rawText = "";
    botContainer.tokenCount = 0;

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buf += decoder.decode(value, {stream: true});
        const lines = buf.split("\n");
        buf = lines.pop();

        for (let ln of lines) {
            if (!ln.trim()) continue;

            const event = JSON.parse(ln);

            // remove typing indicator
            if (typingEl.parentNode) typingEl.remove();

            if (event.type === "token") {
                const token = event.token;

                // Append raw token
                botContainer.rawText += token;
                botContainer.tokenCount++;

                // Render markdown every 5 tokens
                if (botContainer.tokenCount % 5 === 0) {
                    botContainer.innerHTML = "<b>Bot:</b><br>" +
                        marked.parse(botContainer.rawText);
                    chat.scrollTop = chat.scrollHeight;
                }
            }
        }
    }

    // Final markdown render after full stream
    botContainer.innerHTML = "<b>Bot:</b><br>" +
        marked.parse(botContainer.rawText);
    chat.scrollTop = chat.scrollHeight;

    // conversation memory storage
    history.push({ role: "assistant", content: botContainer.rawText });
}

document.getElementById("uploadForm").onsubmit = async e => {
    e.preventDefault();
    const formData = new FormData(e.target);

    await fetch("/upload", { method: "POST", body: formData });
    await fetch("/rebuild", { method: "POST" });

    alert("Uploaded & reindexed!");
};
</script>

</body>
</html>
